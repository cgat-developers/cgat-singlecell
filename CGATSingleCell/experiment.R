description <- "consistent logging and command line interface for R scripts"

library("futile.logger")
library("optparse")
library("uuid")
library("yaml")
suppressMessages(library("jsonlite"))

EXPERIMENT_ENV <- new.env()


experiment_start <- function(option_list, description="",
                             automount=FALSE, mount_section=NULL) {

    option_list <- append(
        option_list,
        list(
            make_option(c("-v", "--verbose"),
                        dest = "loglevel",
                        type = "integer",
                        default = 3,
                        help = "loglevel. The higher, the more output.",
                        metavar = "DEBUG"),
            make_option(c("-L", "--log"),
                        dest = "stdlog",
                        type = "character",
                        default = NULL,
                        help = "file to write logging information to [default = stdout]",
                        metavar = "FILE"),
            make_option(c("-O", "--output-filename-pattern"),
                        dest = "output_filename_pattern",
                        type = "character",
                        default = "%s",
                        help = "pattern for output files - should contain on %s",
                        metavar = "FILE"))
    )
            
    opt_parser <- OptionParser(option_list = option_list, description = description);
    # you can set global argument TRAILING_COMMAND_LINE_ARGUMENTS if
    # you'd like to modify the arguments available to experiment_start
    if (!exists("TRAILING_COMMAND_LINE_ARGUMENTS")) {
      args <- commandArgs(trailingOnly = TRUE)
    } else {
      args <- TRAILING_COMMAND_LINE_ARGUMENTS
    }
    opt <- parse_args(opt_parser, args);

    experiment_start_time <- Sys.time()

    # Setup logging
    LOGLEVEL <- list(FATAL, ERROR, WARN, INFO, DEBUG, TRACE)
    futile.logger::flog.threshold(LOGLEVEL[opt$loglevel + 1])

    if (!is.null(opt$stdlog))
        futile.logger::flog.appender(appender.file(opt$stdlog))

    # Configure log message to print the name of the script where the log message is generated
    layout.fn <- function(level, message, ...) {
        script_name <- sub(".*=", "\n", commandArgs()[4]);
        return(paste0(script_name, "  ", names(level), "  ", Sys.time(), "  ", message))
    };

    #futile.logger::flog.layout(layout.fn);

    uuid <- UUIDgenerate(FALSE)

    futile.logger::flog.info(paste("output generated by", paste(commandArgs(), collapse = " ")))
    futile.logger::flog.info(paste("job started at", Sys.time(),
                    "on", Sys.info()["nodename"],
                    "--",
                    uuid), sep = " ")

    # Todo: setup more specific logging
    # Start up with basic logging information
    futile.logger::flog.info("dumping script parameters")
    futile.logger::flog.info(R.home())
    futile.logger::flog.info(sessionInfo())
    futile.logger::flog.info(paste("option:", names(opt), "=", opt, sep = " "))
    futile.logger::flog.info(paste("system:", names(Sys.info()), "=", Sys.info(), sep = " "))

    # assign globals to env
    assign('experiment_start_time', experiment_start_time, EXPERIMENT_ENV)
    assign('OPTS', opt, EXPERIMENT_ENV)
    assign('experiment_id', uuid, EXPERIMENT_ENV)
    return (opt);
}

experiment_stop <- function() {
  experiment_start_time <- EXPERIMENT_ENV$experiment_start_time
  experiment_stop_time <- Sys.time()

  run_time <- proc.time()

  futile.logger::flog.info(paste(
      "job finished at", Sys.time(), "in",
      round(experiment_stop_time - experiment_start_time, 2),
      "seconds",
      "--",
      "usr_t=", run_time[1],
      "sys_t=", run_time[2],
      "usr_child_t=", run_time[4],
      "sys_child_t=", run_time[5],
      "wall_t=", run_time[3],
      "--",
      EXPERIMENT_ENV$experiment_id,
      sep = " "))
}


get_output_filename <- function(section) {
    return(gsub("%s", section, EXPERIMENT_ENV$OPTS$output_filename_pattern))
}
